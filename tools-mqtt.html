<html lang="en-US"><head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1"/>

<title>TTM4115</title>
<meta property="og:title" content="TTM4115">
<meta property="og:locale" content="en_US">
<meta name="description" content="Design of Communicating Systems">
<meta property="og:description" content="Design of Communicating Systems">


<!--<link rel="stylesheet" type="text/css" href="style.css" />-->
<link href="https://fonts.googleapis.com/css?family=Merriweather:400,400italic,700,700italic|Source+Code+Pro|Source+Sans+Pro:200,300,400,600,400italic,600italic|Rock+Salt" rel="stylesheet" type="text/css">


<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css" integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO" crossorigin="anonymous">
<script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js" integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49" crossorigin="anonymous"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js" integrity="sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy" crossorigin="anonymous"></script>


<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.6.1/css/all.css" integrity="sha384-gfdkjb5BdAXd+lj+gudLWI+BXq4IuLW5IT+brZEZsLFm++aCMlF1V92rMkPaX4PP" crossorigin="anonymous">


<link rel="stylesheet" type="text/css" href="assets/style.css" />
<link rel="stylesheet" type="text/css" href="assets/bootstrap-icons.css">

<script src="assets/anchor.js"></script>
<script src="assets/script-aside.js"></script>
</head>
<body id="top">

<nav class="navbar navbar-expand-md navbar-dark " style="background-color:#666666"#2B65EC"> <!-- fixed-top -->
        <ul class="nav nav-pills">
        <li class="nav-item">
    <a class="nav-link" href="index.html" style="font-weight: bold")>TTM4115</a>
  </li>
        
  <li class="nav-item dropdown">
    <a class="nav-link dropdown-toggle" data-toggle="dropdown" href="#" role="button" aria-haspopup="true" aria-expanded="false">Preparation</a>
    <div class="dropdown-menu">
      <a class="dropdown-item" href="prep-setup.html">Introduction and Setup</a>
      <div class="dropdown-divider"></div>
      <a class="dropdown-item" href="prep-modeling.html">Modeling and Deployment</a>
      <a class="dropdown-item" href="prep-statemachines.html">State Machines</a>
      <a class="dropdown-item" href="prep-user-requirements.html">User Requirements</a>
      <a class="dropdown-item" href="prep-stmpy.html">State Machines in Python</a>
      <a class="dropdown-item" href="prep-agile.html">Agile Development</a>
      <a class="dropdown-item" href="prep-communication.html">Communication</a>
      <a class="dropdown-item" href="prep-interactions.html">Interactions</a>
      <a class="dropdown-item" href="prep-components.html">Components</a>
    </div>
  </li>
  
  <li class="nav-item dropdown">
    <a class="nav-link dropdown-toggle" data-toggle="dropdown" href="#" role="button" aria-haspopup="true" aria-expanded="false">Activities</a>
    <div class="dropdown-menu">
      <a class="dropdown-item" href="unit-setup.html">Team Setup</a>
      <div class="dropdown-divider"></div>
      <a class="dropdown-item" href="unit-modeling.html">Modeling and Deployment</a>
      <a class="dropdown-item" href="unit-statemachines.html">State Machines</a>
      <a class="dropdown-item" href="unit-user-requirements.html">User Requirements</a>
      <a class="dropdown-item" href="unit-stmpy.html">State Machines in Python</a>
  	  <a class="dropdown-item" href="unit-agile.html">Agile Development</a>
      <a class="dropdown-item" href="unit-communication.html">Communication</a>
      <a class="dropdown-item" href="unit-interactions.html">Interactions</a>
      <a class="dropdown-item" href="unit-components.html">Components</a>

      <div class="dropdown-divider"></div>
	  <a class="dropdown-item" href="unit-modeling-diagram-tips.html">Focus: Diagram Tips</a>
      <a class="dropdown-item" href="unit-statemachines-data.html">Focus: State Machines — Data vs. States</a>
	  <a class="dropdown-item" href="unit-statemachines-car.html">Focus: State Machines — Car Lock Example</a>
    </div>
  </li>
  
  <li class="nav-item dropdown">
    <a class="nav-link dropdown-toggle" data-toggle="dropdown" href="#" role="button" aria-haspopup="true" aria-expanded="false">Deliveries</a>
    <div class="dropdown-menu">
      <a class="dropdown-item" href="deliveries.html">Deliveries Overview</a>
      <a class="dropdown-item" href="deliveries-project.html">Semester Project</a>
      <div class="dropdown-divider"></div>
      <a class="dropdown-item" href="deliveries-t1.html">System Spec, version 1</a>
      <a class="dropdown-item" href="deliveries-i1.html">Feedback on version 1</a>
      <div class="dropdown-divider"></div>
      <a class="dropdown-item" href="deliveries-t2.html">System Spec, version 2</a>
      <a class="dropdown-item" href="deliveries-i2.html">Feedback on version 2</a>
      <div class="dropdown-divider"></div>
      <a class="dropdown-item" href="deliveries-t3.html">System Spec, final version</a>
      <a class="dropdown-item" href="deliveries-i3.html">Individual Reflection</a>
    </div>
  </li>

  <li class="nav-item dropdown">
    <a class="nav-link dropdown-toggle" data-toggle="dropdown" href="#" role="button" aria-haspopup="true" aria-expanded="false">Tools</a>
    <div class="dropdown-menu">
      <a class="dropdown-item" href="tools.html">Tools Overview</a>
      <div class="dropdown-divider"></div>
      <a class="dropdown-item" href="tools-python.html">Python</a>
	    <a class="dropdown-item" href="tools-gui.html">Python GUIs with appJar</a>
      <a class="dropdown-item" href="tools-notebooks.html">Python Notebooks</a>
      <a class="dropdown-item" href="tools-mqtt.html">MQTT</a>
      <a class="dropdown-item" href="tools-stmpy.html">STMPY</a>
	  <a class="dropdown-item" href="tools-base.html">Base Architecture</a>
    </div>
  </li>
  
  <li class="nav-item dropdown">
    <a class="nav-link dropdown-toggle" data-toggle="dropdown" href="#" role="button" aria-haspopup="true" aria-expanded="false">Learning</a>
    <div class="dropdown-menu">
      <a class="dropdown-item" href="learning-goals.html">Learning Goals</a>
      <a class="dropdown-item" href="learning-tbl.html">Team-Based Learning</a>
      <a class="dropdown-item" href="learning-teamwork.html">Teamwork Procedures</a>
      <a class="dropdown-item" href="learning-reflection.html">Reflection</a>
      <a class="dropdown-item" href="feedback.html">Feedback</a>
      <a class="dropdown-item" href="learning-grading.html">Grading</a>
      <!--<a class="dropdown-item" href="learning-areas.html">Working Areas</a>-->
      <!--<a class="dropdown-item" href="learning-expectations.html">Expectations</a>-->
    </div>
  </li>
  <!--
  <li class="nav-item">
    <a class="nav-link" href="#">Blackboard</a>
  </li>-->
</ul>

<div class="navbar-nav flex-row ml-md-auto d-none d-md-flex"></div>
             <a class="navbar-brand" href="https://ntnu.edu" title="NTNU Homepage">
      	<svg width="100" height="30">
      		<image xlink:href="https://innsida.ntnu.no/innsida-theme/images/ntnu-graphics/ntnu_logo_white.svg" 
      		src="https://innsida.ntnu.no/innsida-theme/images/ntnu-graphics/ntnu_logo_white.png" width="100%" height="100%" alt="NTNU Logo"></image>
      	</svg>
      </a>
    </nav>


<div class="page">
    </section>
    <section class="content">
<h1 id="mqtt">MQTT</h1>
<p>We use MQTT as the protocol to connect all system components.</p>

    </section>
    <section class="content">
<h1 id="mqtt-broker">MQTT Broker</h1>
<h2 id="install-mosquitto-on-a-raspberry-pi">Install Mosquitto on a Raspberry Pi</h2>

<h3 id="mosquitto-broker">Mosquitto Broker</h3>

<div class="sourceCode" id="cb1"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb1-1" title="1"><span class="ex">sudo</span> apt-get install mosquitto</a></code></pre></div>

<h3 id="mosquitto-command-line-clients">Mosquitto Command-Line Clients</h3>

<div class="sourceCode" id="cb1"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb1-1" title="1"><span class="ex">sudo</span> apt-get install mosquitto-clients</a></code></pre></div>

<h3 id="testing-mosquitto">Testing Mosquitto</h3>
<p>You can now try to subscribe to a topic</p>

<div class="sourceCode" id="cb1"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb1-1" title="1"><span class="ex">mosquitto_sub</span> -d -t example_topic</a></code></pre></div>

<p>and publish something on that topic:</p>

<div class="sourceCode" id="cb1"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb1-1" title="1"><span class="ex">mosquitto_pub</span> -d -t example_topic -m <span class="st">&quot;Time for a coffee&quot;</span></a></code></pre></div>

<p><img src="https://www.iik.ntnu.no/ttm4115/wp-content/uploads/2018/02/mqtt_example-300x231.png" alt="" width="525" height="404" class="alignnone wp-image-368" /></p>
<h3 id="enabling-websockets">Enabling Websockets</h3>
<p>If you want to connect to the MQTT broker also via MQTT over websockets (usually from Javascript) then you need to enable Websockets. For that, create a file called <code>mosquitto.conf</code> in the folder <code>/etc/mosquitto/conf.d</code> and add the follwing lines:</p>
<pre><code>listener 1883
protocol mqtt

listener 1884
protocol websockets</code></pre>

    </section>
    <section class="content">
<h1 id="ntnu-mqtt-broker">NTNU MQTT Broker</h1>
<p>We have setup an MQTT broker with the address <code>mqtt.item.ntnu.no</code>. It is configured with the default ports <code>1883</code> for connections via TCP and <code>1884</code> for connections via websockets.</p>
<pre><code>listener 1883
protocol mqtt

listener 1884
protocol websockets</code></pre>

    </section>
    <section class="content">
<h1 id="mqtt-in-python">MQTT in Python</h1>
<p>After setting up your broker, you can easily make use MQTT in Python with the paho-mqtt package. To install this package with pip, use the command:</p>
<pre><code>python -m pip install paho-mqtt</code></pre>
<p>We can now make a simple script that is able to <strong>publish</strong> information on a topic, to the broker:</p>

<div class="sourceCode" id="cb1"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="cb1-1" title="1"><span class="im">import</span> paho.mqtt.client <span class="im">as</span> mqtt</a>
<a class="sourceLine" id="cb1-2" title="2">port<span class="op">=</span><span class="dv">1883</span></a>
<a class="sourceLine" id="cb1-3" title="3"></a>
<a class="sourceLine" id="cb1-4" title="4"><span class="kw">def</span> on_publish(client,userdata,result):</a>
<a class="sourceLine" id="cb1-5" title="5">    <span class="bu">print</span>(<span class="st">&quot;data published </span><span class="ch">\n</span><span class="st">&quot;</span>)</a>
<a class="sourceLine" id="cb1-6" title="6">    <span class="cf">pass</span></a>
<a class="sourceLine" id="cb1-7" title="7"></a>
<a class="sourceLine" id="cb1-8" title="8">client1<span class="op">=</span> mqtt.Client(<span class="st">&quot;test1&quot;</span>)</a>
<a class="sourceLine" id="cb1-9" title="9">client1.on_publish <span class="op">=</span> on_publish</a>
<a class="sourceLine" id="cb1-10" title="10">client1.<span class="ex">connect</span>(broker,port)</a>
<a class="sourceLine" id="cb1-11" title="11">ret<span class="op">=</span> client1.publish(<span class="st">&quot;mqtt_test&quot;</span>,<span class="st">&quot;The broker is working properly&quot;</span>)</a></code></pre></div>

<p>Now we need a <strong>subscriber</strong> to connect to the broker and recieve the messages we publish:</p>

<div class="sourceCode" id="cb1"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="cb1-1" title="1"><span class="im">import</span> paho.mqtt.client <span class="im">as</span> mqtt</a>
<a class="sourceLine" id="cb1-2" title="2">    <span class="kw">def</span> on_connect(client, userdata, flags, rc):</a>
<a class="sourceLine" id="cb1-3" title="3">    <span class="bu">print</span>(<span class="st">&quot;Connected with result code &quot;</span><span class="op">+</span><span class="bu">str</span>(rc))</a>
<a class="sourceLine" id="cb1-4" title="4"></a>
<a class="sourceLine" id="cb1-5" title="5">client.subscribe(<span class="st">&quot;mqtt_test/#&quot;</span>)</a>
<a class="sourceLine" id="cb1-6" title="6"><span class="kw">def</span> on_message(client, userdata, msg):</a>
<a class="sourceLine" id="cb1-7" title="7">    <span class="bu">print</span>(<span class="st">&quot;Topic: &quot;</span> <span class="op">+</span> msg.topic)</a>
<a class="sourceLine" id="cb1-8" title="8">    <span class="bu">print</span>(<span class="st">&quot;Message: &quot;</span> <span class="op">+</span> <span class="bu">str</span>(msg.payload))</a>
<a class="sourceLine" id="cb1-9" title="9"></a>
<a class="sourceLine" id="cb1-10" title="10">client <span class="op">=</span> mqtt.Client()</a>
<a class="sourceLine" id="cb1-11" title="11">client.on_connect <span class="op">=</span> on_connect</a>
<a class="sourceLine" id="cb1-12" title="12">client.on_message <span class="op">=</span> on_message</a>
<a class="sourceLine" id="cb1-13" title="13"></a>
<a class="sourceLine" id="cb1-14" title="14">client.<span class="ex">connect</span>(<span class="st">&quot;192.168.10.168&quot;</span>, <span class="dv">1883</span>, <span class="dv">60</span>)</a>
<a class="sourceLine" id="cb1-15" title="15"></a>
<a class="sourceLine" id="cb1-16" title="16">client.loop_forever()</a></code></pre></div>

<p>More information on the paho package can be found here: <a href="https://pypi.python.org/pypi/paho-mqtt/">https://pypi.python.org/pypi/paho-mqtt/</a></p>

<p>If there is an error in the <code>on_message()</code> function, you may not see an error and nothing is happening, and it may look as if the client doesn’t receive any messages. To prevent such errors, add a <code>print('Message received!')</code> line at the start of the message so you see it was called. Make sure this first statement does not have any problems (like unkown variables) so that it does not fail.</p>
<p>You can also place any code that could cause an error into a <code>try:</code> … <code>except:</code> block to handle any exceptions locally.</p>

<h2 id="subscribe-to-system-messages">Subscribe to system messages</h2>
<p>client.subscribe(“$SYS/#”)</p>

    </section>
    <section class="content">
<h1 id="debugging-with-mqtt.fx">Debugging With MQTT.FX</h1>
<p>MQTT.FX is a tool useful during development. (If you wonder, the name <em>MQTT.FX</em> just comes from the fact that it is implemented in Java FX, but you can forget about that.) Using MQTT.FX is really simple, but because we have now talked about brokers, clients, publishers and subscribers, you may loose track and wonder what this MQTT.FX does: Think of it as a debugger for MQTT, and you can use it like Wireshark. Once the system is done, you don’t need MQTT.FX anymore.</p>
<p>Essentially, MQTT.FX is a MQTT client, and can as such connect to an MQTT broker, subscribe to topics and send messages to topics. This does not sound like much. However, MQTT.FX has a generic user interface, you can use MQTT.FX while you construct your application to see how the other system components publish messages, and you can also “inject” messages into the system, by publishing to any topic you want.</p>
<p><a class="arrow" href="https://mqttfx.jensd.de">Download MQTT.FX</a></p>

<div class="figure">
<img src="figures/mqtt/mqtt-fx-publish.png" width="100%"/>
</div>
<h2 id="publishing-messages">Publishing Messages</h2>
<p>Imagine you have created a MQTT client that runs a certain action when it receives a message, but you are not doen with the component that should send the message. To test at least the component that should receive the message, you can use MQTT.FX to publish a message with that content to the topic, and the component under test will behave as if the message was sent in the final system.</p>

<div class="figure">
<img src="figures/mqtt/mqtt-fx-subscribe.png" width="100%"/>
</div>
<h2 id="observing-communication">Observing Communication</h2>
<p>Because MQTT uses the publish-subscribe pattern, it can simply subscribe to any topics that are interesting in your application and you can see which messages are sent to these topics, without disturbing the communication in the system. To achieve the same in HTTP, for instance, you need a tool like Wireshark.</p>

    </section>
</div>


<footer></footer>
<script>
  anchors.options.visible = 'touch';
  anchors.add("h1, h2, h3");
</script>
</body>
</html>