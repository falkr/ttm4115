<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content="">
  <meta name="author" content="">
  <meta name="generator" content="">
  <title>IIK Education Guide</title>
  <link rel="canonical" href="https://edu.iik.ntnu.no">
  <!-- Bootstrap core CSS -->
  <link href="../assets/bootstrap.min.css" rel="stylesheet">
  <!-- Custom styles for this template -->
  <link href="../assets/style.css" rel="stylesheet">
  <link rel="stylesheet" href="../assets/bootstrap-icons.css">
  <script src="../assets/anchor.js"></script>
  <style type="text/css">
    a.ntnu-button {
    font: 600 14px "Source Sans Pro", Georgia, serif;
    background: #fff;
    color: #00509e;
    border: 1px solid #00509e;
    border-color: #00509e !important;
    border-style: solid !important;
    border-radius: 10rem;
    display: inline-block;
    padding: 5px 15px;
    height: auto;
    font-weight: bold;
    line-height: 1.5em;
    text-align: center;
    vertical-align: top;
    cursor: pointer;
    text-decoration: none
}

a.ntnu-button:hover {
    background: #00509e;
    color: #fff;
    text-decoration: none
}
.person-card img {
  width: 56px;
  border: 1px solid #eee;
}

.person-card-name {
  font-weight: 600;
}

.person-card-email {
  font-size: 0.8em;
}

.person-card-detail {
  font-size: 0.8em;
}
div.check ul,
div.check ul li {
  padding: 0;
  margin: 0;
  list-style: none;
}

div.check ul {
  margin: 2em 0;
}

div.check ul li {
  margin: 1em;
  margin-left: 3em;
}

div.check ul li:before {
  content: '\f26a';
  font-family: bootstrap-icons !important;
  font-size:20;
  float: left;
  margin-left: -1.5em;
  color: #1481b8;
}
div.delivery p {
  padding: 10px;
  background-color: #ffd9ab;
  font-family: "Source Sans Pro", Georgia, serif;
  border-radius: 5px;
  border-left: 6px solid #fc8c03; 
}
  
div.delivery p::before {
  content: 'Delivery: ';
  font-family: "Source Sans Pro", Georgia, serif;
  color: #fc8c03;
  display: inline;
  font-weight: bold;
}
div.figure {
  padding: 20px 0 20px 0;
  width: 100%;
}

div.figurefullwitdth {
  padding: 20px 0 20px 0;
  margin-left: -33px;
  margin-right: -33px;
  width: 100%;
}
div.goals ul,
div.goals ul li {
  padding: 0;
  margin: 0;
  list-style: none;
}

div.goals ul {
  margin: 2em 0;
}

div.goals ul li {
  margin: 1em;
  margin-left: 3em;
}

div.goals ul li:before {
  content: '\f26a';
  font-family: bootstrap-icons !important;
  font-size:20;
  float: left;
  margin-left: -1.5em;
  color: #1481b8;
}
.w3collapsible {
  background-color:#f0e9db;
  color: #868279; 
  padding: 8px 18px 8px 8px;
  cursor: pointer;
  width: 100%;
  border: none;
  border-radius: 3px 3px 0 0;
  text-align: left;
  outline: none;
  font-size: 15px;
}

.w3active, .w3collapsible:hover {
  background-color: #f0e9cb;
}

.w3content {
  filter: blur(3px);
  padding: 0 18px;
  display: block;
  overflow: hidden;
  background-color: #f3f3f3;
  margin-bottom: 15px;
}


/*tr.rubric_title {background-color: lightgrey}*/
/*tr.rubric_a {background-color: #D0E8DC}
tr.rubric_b {background-color: #EEF7DB}
tr.rubric_c {background-color: #FCFDE3}
tr.rubric_d {background-color: #FDF3D6}
tr.rubric_e {background-color: #F8D9C2}
tr.rubric_f {background-color: #EBBCB9}

tr.rubric_title {background-color: white; 
	border-top: 2px black solid; 
	border-bottom: 2px black solid;}
td.rubric_title {background-color: white;}
td.rubric_a {background-color: #D0E8DC}
td.rubric_b {background-color: #EEF7DB}
td.rubric_c {background-color: #FCFDE3}
td.rubric_d {background-color: #FDF3D6}
td.rubric_e {background-color: #F8D9C2}
td.rubric_f {background-color: #EBBCB9}

th.rubric_title {background-color: white}
th.rubric_a {background-color: #D0E8DC}
th.rubric_b {background-color: #EEF7DB}
th.rubric_c {background-color: #FCFDE3}
th.rubric_d {background-color: #FDF3D6}
th.rubric_e {background-color: #F8D9C2}
th.rubric_f {background-color: #EBBCB9}

table.rubric th {border-top: 2px black solid; border-bottom: 2px black solid; text-align: center;
	vertical-align:top;}
table.rubric td {width:22%; border-bottom: 1px black solid;}}*/

.rubric p {margin: 0px}
.rubric th {border-top: 1.4px black solid; border-bottom: 1.4px black solid; text-align: center; padding:6px;}
.rubric td {border-bottom: 0.7px black solid; vertical-align:top; font-size:12px; padding:6px;}
.rubric th {font-size:12px; vertical-align:top; }
.rubric td:nth-child(2), .rubric th:nth-child(2){background-color: #D0E8DC; width:22%}
.rubric td:nth-child(3), .rubric th:nth-child(3){background-color: #FCFDE3; width:22%}
.rubric td:nth-child(4), .rubric th:nth-child(4){background-color: #F8D9C2; width:22%}
.rubric td:nth-child(5), .rubric th:nth-child(5){background-color: #EBBCB9; width:22%}
.rubric tfoot td {text-align:right; border-bottom: none; padding: 1px;}
.rubric tfoot a {font-size: 12px; font-style: italic; color: gray}


table.weekplan {
  width: 100%;
  table-layout: fixed;
}

table.weekplan td {
  background-color: #1481b8;
  color: white;
}

table.weekplan td, table.weekplan th {
  text-align: center;
}

table.weekplan td:empty {
  background-color: white;
}

table.weekplan td:first-child {
  background-color: white;
  color: grey;
}

table.weekplan a {
  font-weight:bold;
  color: white;
  text-decoration: underline;
}

  </style>
</head>

<body>


  <nav class="navbar navbar-expand-md navbar-dark " style="background-color:#333333">
    <!-- <nav class="navbar navbar-expand-md navbar-dark " style="background-color:#2B65EC"> -->


    <div class="navbar-nav">
      <!-- flex-row ml-md-auto d-none d-md-flex">-->
      <a class="navbar-brand" href="https://ntnu.edu" title="NTNU Homepage">
        <svg width="auto" height="25px">
          <image xlink:href="https://innsida.ntnu.no/innsida-theme/images/ntnu-graphics/ntnu_logo_white.svg"
            src="https://innsida.ntnu.no/innsida-theme/images/ntnu-graphics/ntnu_logo_white.png" width="100%"
            height="100%" alt="NTNU Logo"></image>
        </svg>
      </a>
    </div>

    <div class="navbar-nav flex-row ml-md-auto d-none d-md-flex flex-grow-1" style="margin-left:2rem">


      <ul class="nav nav-pills">
        <li class="nav-item">
          <a class="nav-link" href="index.html" style="font-weight: bold; color:white" )>edu.<span
              style="font-weight:200">iik.ntnu.no</span></a>
        </li>
      </ul>
    </div>
  </nav>


  <main class="container">

    <div class="row g-5 justify-content-md-center pb-5">



      <div class="col-md-8" style="margin-top: 6rem;">
        <div class="page">
    </section>
    <section class="content">
<h1>State Machines in Python</h1>
<p>In this unit, you will learn how to implement state machines in Python. Achieving this is valuable for several reasons:</p>
<ul>
<li>You will be able to deepen your understanding about state machines in general.</li>
<li>You will be able to solve arbitrarily complex synchronization tasks in Python.</li>
<li>You will have a framework for the implementation during the semester project.</li>
</ul>

<h3>For the Semester Project</h3>
<p>To have your code in sync with your state machine diagrams and handle concurrency in an effective way, you will program parts of your semester project using STMPY.</p>

<h2>Benefits of State Machines in Code</h2>
<p>State machines are useful also at the code level when there is a lot of concurrency going on,
and a component needs to order a set of events that can come more or less in any order.
You may think that there is support for threads in most programming languages, and that this is enough to handle concurrency.
However, sometimes also this support is very specific to certain problems and not simple to learn.
For example, when learning Java, which has extensive support for concurrency,
the concurrency part is considered the most difficult one, and most developers have to look into a book when doing more elaborate tasks.
Python has even less mature support for concurrency and synchronization, and also this is hard to get right.
Just look at this:</p>

<div class="figure">
<img src="../../pages/figures/statemachines/threads.png" alt="Concurrent behavior starts simple and gets quickly so complex that even the best developers give up when using the wrong approach." width="100%"/>
<span name="../../pages/figures/statemachines/threads.png">&nbsp;</span>
<aside name="../../pages/figures/statemachines/threads.png"><p><p>Concurrent behavior starts simple and gets quickly so complex that even the best developers give up when using the wrong approach.</p>
</p></aside>
</div>
<span name="ca90ad"></span><aside name="ca90ad"><p>The reason for looking at state machines is simple: Concurrency in programming languages is hard, even for experienced developers.</p>
</aside>
<p>Many programmers cannot even handle very simple threading problems correctly.</p>
<blockquote class="twitter-tweet" data-lang="en"><p lang="en" dir="ltr">A programmer had a problem. He thought to himself, &quot;I know, I&#39;ll solve it with threads!&quot;. has Now problems. two he</p>&mdash; Davidlohr Bueso (@davidlohr) <a href="https://twitter.com/davidlohr/status/288786300067270656?ref_src=twsrc%5Etfw">January 8, 2013</a></blockquote> <script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script> 

<p>With state machines, we have a simple model that scales nicely with various challenges in concurrency.
This does not make concurrency problems vanish, but you have a good tool to solve challenges.
State machines are easy to debug, since you can check in which current state they are,
and because you can look at a trace of events that explains how they got there.</p>
<p>It turns out, that state machines are also relatively easy to implement,
and we can run many different state machines within the same thread.
This means we can do a <em>lot</em> of concurrent things in just own thread,
and <strong>just one busy while loop</strong>, which can make our programs quite efficient.</p>
<p>But how can a state machine do it? With state machines, we have a notation that motivates us to define behavior in short pieces, which are the transitions.
Think of them as short little pieces of thread, as illustrated in the figure below.
Threads of different color belong to different tasks.
But because these tasks are executed concurrently, the state machine sorts them and executes one of them at a time.
The states in between are just the ordering criteria between them.
(If this analogy is not <em>entirely</em> clear to you now, don't worry. You will understand more once we implement state machines.)</p>

<div class="figure">
<img src="../../pages/figures/statemachines/transition-sequencing.png" alt="A state machine takes concurrent behavior, transformes it into many transitions and sorts their execution, so that only one of them is executed at the same time." width="100%"/>
<span name="../../pages/figures/statemachines/transition-sequencing.png">&nbsp;</span>
<aside name="../../pages/figures/statemachines/transition-sequencing.png"><p><p>A state machine takes concurrent behavior, transformes it into many transitions and sorts their execution, so that only one of them is executed at the same time.</p>
</p></aside>
</div>
<p>What you also gain immediately is the ability for parallel computing. State machines can be grouped and execute on a single process or thread, then occupying different CPUs. This is very helpful when we have a lot of tasks that also take some time, to utilize all computing resources we may have.</p>

    </section>
    <section class="content">
<h1>From Diagram to Code</h1>
<p>There are many different possibilities when we want to come from a diagram to code. For this course, we have selected the following strategy:</p>
<ul>
<li>We define a Python package called <strong>STMPY</strong> that supports the creation of state machines.</li>
<li>STMPY provides the classes <strong>Machine</strong> and <strong>Driver</strong>, which execute state machine behavior.</li>
<li>States and transitions are defined using Python dicts together with code.</li>
<li>The dicts for state and transitions correspond to diagrams and are easy to create but need manual work.</li>
<li>STMPY state machines can be combined with other Python code. Actions called from the state machine can execute other Python code, and Python programs can send messages into STMPY, so that they are received by state machines as triggers.</li>
</ul>
<p>Despite the manual step with writing the code, our solution still has good <strong>traceability</strong>. This means it is be relatively easy to see how model (the state machine) and the code (in Python) correspond to each other. We can <strong>trace back</strong> the code from the model, and vice-versa, look at the code and trace back where in the model it is specified.</p>
<p>Alternatives would be to generate code automatically from diagrams, but this requires a good state machine editor and very formal syntax for it. Yet another possibility would be to feed the state machine diagram directly to an interpreter that then executes it. But again, this would require a very detailed syntax for actions in the state machine. Instead, with STMPY, we have the flexibility to write state machines how we want, and then use all of Python, just with a little manual effort to code the state machines as Python data structures (dicts) and some extra glue code.</p>

<h2>State Machine Execution</h2>
<p>As a first overview, have a look at the following whiteboard sketch:</p>

<div class="figure">
<img src="../../pages/figures/statemachines/stmpy-sketch.jpg" alt="The original sketch from a whiteboard when planning the first release for STMPY." width="100%"/>
<span name="../../pages/figures/statemachines/stmpy-sketch.jpg">&nbsp;</span>
<aside name="../../pages/figures/statemachines/stmpy-sketch.jpg"><p><p>The original sketch from a whiteboard when planning the first release for STMPY.</p>
</p></aside>
</div>
<ul>
<li>
<p>A state machine diagram is implemented by an instance of Python class <strong>Machine</strong> (in green). It takes care of the sequence in which transitions are executed, which states there are, and which Python methods are called by the actions in the state machine.</p>
</li>
<li>
<p>A driver (in blue) is executing several machines. <strong>One driver keeps track of several machines.</strong> It has <strong>one event queue</strong> that collects all the events (signals and timer expirations) for its state machines.</p>
</li>
<li>
<p>One driver also has a single while loop, running in a single thread or process. From this while loop, a driver executes all the state machines assigned to it, one at a time.</p>
</li>
<li>
<p>A driver also manages all timers for all of its state machines.</p>
</li>
<li>
<p>The red arrow shows that events for the queue come from expires timers, signals sent by other state machines, and signals that are sent by components out of the control of the driver.</p>
</li>
<li>
<p>The separation of driver and machine gives us more flexibility. Since one driver corresponds to one thread or process, we can decide which state machines should run in the same thread. Giving each state machine their own thread can be too costly since we may want to have many state machines but assigning all state machines to the same thread or process is also not good for larger systems. Therefore, we can decide on the mapping between driver and machine more flexibly.</p>
</li>
</ul>

<p>We will go through machines and drivers and their Python API in the following notebooks.</p>

    </section>
    <section class="content">
<h1>Jupyter Notebooks Introducing STMPY</h1>
<p>To introduce STMPY you step by step and while executing code, we created a series of Python notebooks.
You have two possibilities to run them</p>

<h3>Alternative 1: Install Notebooks on Your Computer</h3>
<p>In this solution, you run Jupyter on your own computer.</p>
<ul>
<li>Install Jupyter Lab on your computer, following <a href="tools-notebooks.html">these instructions</a>.</li>
<li>Install the STMPY library:</li>
</ul>

<div class="sourceCode" id="cb1"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="ex">python3</span> <span class="at">-m</span> pip install <span class="at">--upgrade</span> stmpy</span></code></pre></div>
<p>We also need our own widgets in the notebooks, so run the following two commands:</p>

<div class="sourceCode" id="cb1"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="ex">python3</span> <span class="at">-m</span> pip install ipywidgets</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="ex">jupyter</span> nbextension enable <span class="at">--py</span> widgetsnbextension</span></code></pre></div>
<ul>
<li>Visit the Github repository <a href="https://github.com/falkr/stmpy-notebooks">https://github.com/falkr/stmpy-notebooks</a>.
<ul>
<li>You can pull the repository via Git, or</li>
<li>Download directly the contents <a href="https://github.com/falkr/stmpy-notebooks/archive/master.zip">as a ZIP file, using this link</a>.</li>
</ul>
</li>
</ul>

<h3>Alternative 2: Use Binder</h3>
<p>Binder runs notebooks online.
Use this method if you have troubles running the notebooks on your own computer.</p>
<p><a href="https://mybinder.org/v2/gh/falkr/stmpy-notebooks/HEAD"><img src="https://mybinder.org/badge_logo.svg" alt="Binder" /></a></p>

<h2>Run the Notebooks</h2>
<p>The following notebooks will introduce you to STMPY step by step.
At this time, you don't have to program anything on your own, just execute the cells and observe what's happening. So make sure you are not rushing through the cells too fast.</p>
<h3>State Machines in Python - Part 1</h3>
<ul>
<li>Open the first notebook, stored in the file <strong>State Machines in Python - Part 1.ipynb</strong></li>
<li>In this notebook you learn all the basics of state machines in STMPY.</li>
</ul>

<h3>State Machines in Python - Part 2</h3>
<ul>
<li>Work through the content of the notebook <strong>State Machines in Python - Part 2.ipynb</strong></li>
<li>You learn how we build very simple user interfaces in notebooks. We also use signals to send data from the user interface into the state machine.</li>
</ul>
<h3>State Machines in Python - Part 3</h3>
<ul>
<li>Work through the content of the notebook <strong>State Machines in Python - Part 3.ipynb</strong></li>
<li>You learn how you can also create states that have <strong>entry</strong> and <strong>exit</strong> actions.</li>
</ul>

<h3>State Machines in Python - Part 4</h3>
<ul>
<li>Work through the content of the notebook <strong>State Machines in Python - Part 4.ipynb</strong></li>
<li>You learn how to support decisions in state machines using <strong>compound transitions.</strong></li>
</ul>

    </section>
</div>
      </div>




    </div>

  </main>

  <footer class="blog-footer">

  </footer>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p"
    crossorigin="anonymous"></script>
  <script>
    anchors.add('h1').add('h2').add('h3');
    anchors.options.visible = 'always';
  </script>
  <script>
    














  </script>
</body>

</html>